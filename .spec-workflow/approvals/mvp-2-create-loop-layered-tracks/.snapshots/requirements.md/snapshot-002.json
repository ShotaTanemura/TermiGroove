{
  "id": "snapshot_1759065204447_gqge2me8b",
  "approvalId": "approval_1759058410352_32mme00j5",
  "approvalTitle": "Review requirements for mvp-2-create-loop-layered-tracks",
  "version": 2,
  "timestamp": "2025-09-28T13:13:24.447Z",
  "trigger": "revision_requested",
  "status": "pending",
  "content": "# Requirements – mvp-2-create-loop-layered-tracks\n\n## Introduction\n\nEnable performers on the Pads screen to overdub fresh material onto an already playing loop so that each pass through the loop accumulates layered tracks without stopping the performance. The feature extends the existing loop capture workflow with track-level separation, transport controls for pause/clear, and real-time monitoring that keeps the jam fluid.\n\n## Alignment with Product Vision\n\n- Advances **Keyboard Mastery** by keeping overdub, pause, resume, and clear actions bound to Space and Control+Space with no mouse interaction.\n- Reinforces **Retro-Futuristic Clarity** by tracking each overdub as an explicit layer that the UI can surface in transport and future mix widgets.\n- Upholds **Reliability Through TDD** and the Tempo & Timing Control pillar by requiring deterministic count-in, sample scheduling, and latency budgets under 10 ms during overdub sessions.\n- Supports the business goal of collaborative live looping by letting a performer (or duo) build up arrangements in real time from the terminal.\n\n## Requirements\n\n### Requirement 1 – Overdub lifecycle entry and count-in\n\n**User Story:** As a Pads performer listening to an existing loop, I want to punch into a new overdub with the same Space-triggered count-in so that layering feels identical to the initial recording.\n\n#### Acceptance Criteria\n\n1. WHEN loop mode is playing with valid BPM and measures AND the performer presses Space, THEN the loop engine SHALL enter `Ready`, emit exactly four metronome ticks at the configured tempo, and transition to `Recording` on the downbeat immediately after the fourth tick.\n2. IF the performer cancels during the count-in by pressing Space again, THEN the engine SHALL return to `Playing` without mutating any previously recorded tracks.\n3. WHEN `Recording` begins for an overdub, THEN the loop engine SHALL mark the overdub start at offset 0 of the current cycle so captured events align to the active loop timeline.\n\n### Requirement 2 – Real-time overdub capture\n\n**User Story:** As a performer layering parts, I want every pad I trigger during an overdub to monitor in my headphones and store precise offsets so future cycles replay what I just played.\n\n#### Acceptance Criteria\n\n1. WHEN `Recording` is active AND the performer presses any mapped pad key, THEN the system SHALL play the sample immediately for monitoring AND store an event containing `(pad_key, velocity if available, offset_ms_from_overdub_start)`.\n2. WHEN additional overdub events are captured while prior tracks already exist, THEN the engine SHALL buffer the new events in a distinct track structure without mutating existing track data.\n3. WHEN multiple events share the same millisecond offset, THEN the engine SHALL preserve their arrival order in the track data so playback matches the performer’s timing.\n\n### Requirement 3 – Track creation and layered playback\n\n**User Story:** As a performer, I want each overdub take to become its own named track so that the loop automatically plays every layer once per cycle with tight timing.\n\n#### Acceptance Criteria\n\n1. WHEN an overdub cycle ends because the loop length elapses, THEN the engine SHALL seal the captured events into a new track, append it to the loop’s track list, and expose the track metadata (name/id, event count, duration) to the UI layer.\n2. WHEN playback advances through subsequent cycles, THEN every track in the track list SHALL emit its stored events exactly once per cycle at their recorded offsets with jitter ≤2 ms.\n3. WHEN no events exist in a given track during a cycle, THEN the engine SHALL avoid emitting redundant play commands to preserve audio headroom.\n\n### Requirement 4 – Transport controls during layered looping\n\n**User Story:** As a performer juggling layers, I want to pause, resume, or clear the loop using Space so I can manage the arrangement mid-performance without touching the file navigator.\n\n#### Acceptance Criteria\n\n1. WHEN `Recording` is active AND Space is pressed, THEN the engine SHALL stop recording immediately, preserve the captured events up to that moment as a track, and continue playback in `Playing` state.\n2. WHEN the loop is playing AND Space is pressed, THEN the engine SHALL pause playback, maintain the current track list, and expose `Paused` state to the UI.\n3. WHEN the loop is paused AND Space is pressed, THEN the engine SHALL resume playback from the next cycle boundary using the existing tracks.\n4. WHEN the loop is playing (or paused) AND Control+Space is pressed, THEN the engine SHALL clear all tracks, stop playback, and reset to `Idle` with an empty track list.\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n- **Single Responsibility Principle:** Track layering logic lives in the loop engine module; UI and input layers interact via explicit commands/events.\n- **Modular Design:** Track storage structures remain isolated so future features (mute, delete) can manipulate individual tracks without touching core scheduling.\n- **Dependency Management:** Overdub logic reuses the existing clock, audio bus, and AppState messaging without introducing cross-module cyclic dependencies.\n- **Clear Interfaces:** Extend the loop engine API with explicit methods for `start_overdub`, `commit_overdub`, `pause_loop`, and `clear_loop`, each returning deterministic state snapshots for testing.\n\n### Performance\n- Maintain ≤10 ms additional latency between pad press and monitored audio during overdubs.\n- Ensure layered playback scheduling exhibits ≤2 ms jitter per event over at least 30 consecutive cycles.\n- Guarantee metronome ticks and playback commands do not starve each other on the audio callback thread.\n\n### Security\n- Restrict overdub operations to already loaded samples; never load new file paths during recording.\n- Validate Control+Space input to avoid accidental clears triggered by unrelated modifiers (e.g., require explicit key chord recognition).\n\n### Reliability\n- Provide deterministic state transitions (`Idle ↔ Ready ↔ Recording ↔ Playing ↔ Paused`) with comprehensive unit and integration coverage.\n- Clearing a loop MUST release buffered audio commands and deallocate track memory to prevent stale playback on subsequent sessions.\n- Loop mode MUST avoid XRuns under the defined layering workflow on macOS 14 reference hardware.\n\n### Usability\n- Surface transport state (`Ready`, `Recording`, `Playing`, `Paused`) within one render frame so performers receive immediate feedback.\n- Present per-track counts (e.g., total layered tracks) in the transport strip or status area for quick glanceability.\n- Provide audio-only confirmation (metronome ticks, sample monitoring) to maintain keyboard-only operation.\n\n## Dependencies & Interfaces\n- Builds on the loop capture foundation from `mvp-2-record-loop-track` and BPM/bars configuration from `mvp-2-setup-bpm-and-loop-bars`.\n- Extends the loop engine housed under `src/state/loop_engine.rs`, which already exposes clocked scheduling and state snapshots.\n- Requires input routing in `src/input.rs` to recognize Control+Space and to signal overdub start/stop events.\n- UI updates occur through `src/ui.rs` transport components and should display aggregated track state without blocking the render loop.\n\n## Decision Log\n- 2025-09-28 — Adopt a track list structure (`Vec<LoopTrack>`) within the loop engine to preserve each overdub separately, enabling future mute/solo features.\n- 2025-09-28 — Treat Control+Space as a destructive clear that resets the loop state entirely, paired with UI confirmation cues, to keep live performance semantics explicit.\n\n## References\n- Notion user story: https://www.notion.so/27c4150965e48001ac5cf80d68e63dbf\n- Parent epic: https://www.notion.so/2704150965e480b0ab9ce85f5b5c7254\n- Steering documents: `.spec-workflow/steering/product.md`, `.spec-workflow/steering/tech.md`, `.spec-workflow/steering/structure.md`\n\n",
  "fileStats": {
    "size": 7965,
    "lines": 99,
    "lastModified": "2025-09-28T11:20:35.235Z"
  },
  "comments": []
}