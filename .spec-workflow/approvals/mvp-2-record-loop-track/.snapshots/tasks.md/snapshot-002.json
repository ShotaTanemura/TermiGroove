{
  "id": "snapshot_1759028091996_y9gh7ne4w",
  "approvalId": "approval_1759027998079_zdfplq9vv",
  "approvalTitle": "Tasks draft for mvp-2-record-loop-track",
  "version": 2,
  "timestamp": "2025-09-28T02:54:51.996Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Tasks – mvp-2-record-loop-track\n\n- [ ] 1. Behavior matrix for loop lifecycle and timing invariants\n  - File: docs/tdd/loop_engine/behavior-matrix.md\n  - Capture exhaustive scenarios for Idle → Ready → Recording → Playing, metronome timing, cancellation, and BPM/bars changes. Include invariants for latency and command dispatch ordering. Identify non-goals (UI timelines, overdubbing) and open questions (e.g., audio thread failure handling).\n  - Purpose: Define TDD acceptance surface and guard against regressions when LoopEngine evolves.\n  - _Leverage: requirements.md, design.md, docs/tdd/_shared/invariants.md (create if missing)_\n  - _Requirements: 1, 2, 3, 4, 5, 6_\n  - _Prompt: Role: TDD Analyst for real-time audio systems | Task: Enumerate positive, negative, and edge cases for loop lifecycle, metronome count-in, recording cancellation, and playback scheduling; state invariants for latency and command ordering; document non-goals and open questions | Restrictions: Do not specify implementation details or data structures; keep cases testable and traceable to requirements | Success: Matrix covers Ready/Recording/Playing transitions, metronome behavior, cancellation semantics, and BPM/bars change handling; stakeholders sign off as the definitive test list_\n\n- [ ] 2. Red #1 — Happy path loop capture\n  - File: tests/loop_engine/loop_happy_path.rs\n  - Write a unit test driving LoopEngine through Ready → Recording → Playing with deterministic FakeClock and AudioBusMock; assert metronome commands, event capture offsets, and playback scheduling for a single cycle.\n  - Purpose: Establish first failing test for minimal end-to-end lifecycle.\n  - _Leverage: docs/tdd/loop_engine/behavior-matrix.md_\n  - _Requirements: 1, 2, 3, 4_\n  - _Prompt: Role: Rust TDD Engineer | Task: Implement a failing test for the loop happy path using FakeClock/AudioBusMock, asserting metronome command count, captured events, and playback scheduling | Restrictions: Do not implement production code; no reliance on real time or audio thread | Success: Test fails because LoopEngine is not implemented; failure message highlights missing lifecycle transitions_\n\n- [ ] 3. Green #1 — Minimal LoopEngine to satisfy happy path\n  - File: src/state/loop_engine.rs (new)\n  - Implement LoopEngine struct, state enum, and minimal logic to pass happy path test: handle space presses, count-in ticks, event capture, automatic playback scheduling for one cycle (no cancellation yet). Introduce Clock and AudioBus traits.\n  - Purpose: Deliver minimal functionality for the primary loop recording scenario.\n  - _Leverage: tests/loop_engine/loop_happy_path.rs, requirements.md, design.md_\n  - _Requirements: 1, 2, 3, 4_\n  - _Prompt: Role: Implementation-focused Rust developer | Task: Implement LoopEngine basics (state transitions, count-in, event capture, playback scheduling) to satisfy the happy path test; define Clock/AudioBus abstractions | Restrictions: Keep implementation minimal; no persistence; no manual cancellation or BPM change handling yet | Success: Happy path test passes; code remains under ~300 lines with clear separation of concerns_\n\n- [ ] 4. Red #2 — Cancel during Ready or Recording\n  - File: tests/loop_engine/loop_cancel.rs\n  - Add tests covering space press during Ready (aborts count-in) and during Recording (clears events, returns to Idle). Assert AudioBus receives cancellation logs only via state change (no extra commands). Ensure FakeClock determinism.\n  - Purpose: Drive cancellation semantics per requirements.\n  - _Leverage: docs/tdd/loop_engine/behavior-matrix.md_\n  - _Requirements: 1, 2, 5_\n  - _Prompt: Role: Rust TDD Engineer | Task: Implement failing tests for cancellation during Ready/Recording, asserting state transitions and cleared events | Restrictions: Isolate tests; no production code changes | Success: Tests fail due to missing cancellation handling_\n\n- [ ] 5. Green #2 — Implement cancellation handling\n  - File: src/state/loop_engine.rs\n  - Extend LoopEngine to handle cancellation paths (Ready → Idle, Recording → Idle with event clear) and update state getters. Ensure metronome generation stops on cancel.\n  - Purpose: Fulfill manual stop behavior.\n  - _Leverage: tests/loop_engine/loop_cancel.rs, design.md_\n  - _Requirements: 1, 2, 5_\n  - _Prompt: Role: Implementation-focused Rust developer | Task: Update LoopEngine to satisfy cancellation tests, clearing events and halting metronome on cancel | Restrictions: Avoid refactoring existing passing paths; maintain minimal changes | Success: Cancel tests pass alongside previous happy path test_\n\n- [ ] 6. Red #3 — BPM/bars change reset behavior\n  - File: tests/loop_engine/loop_bpm_reset.rs\n  - Add test verifying that invoking `loop_engine.reset_for_new_tempo(bpm, bars)` (to be called by AppState) clears events and returns state to Idle. Include guard that playback does not emit stale commands post-reset.\n  - Purpose: Enforce loop invalidation when tempo context changes.\n  - _Leverage: docs/tdd/loop_engine/behavior-matrix.md_\n  - _Requirements: 5_\n  - _Prompt: Role: Rust TDD Engineer | Task: Add failing test for BPM/bars change forcing loop reset | Restrictions: Use FakeClock; no production updates | Success: Test fails indicating missing reset behavior_\n\n- [ ] 7. Green #3 — Implement tempo reset hook\n  - File: src/state/loop_engine.rs\n  - Add public method to reset loop data, clear events, and stop playback scheduling when tempo changes. Integrate with LoopEngine update cycle to ensure no lingering commands.\n  - Purpose: Support tempo change requirement.\n  - _Leverage: tests/loop_engine/loop_bpm_reset.rs_\n  - _Requirements: 5_\n  - _Prompt: Role: Implementation-focused Rust developer | Task: Implement tempo reset logic, ensuring no playback occurs after reset | Restrictions: Keep method side-effect scoped; maintain existing functionality | Success: Tempo reset test passes_\n\n- [ ] 8. Integrate LoopEngine into AppState\n  - File: src/app_state.rs, src/input.rs, src/audio.rs\n  - Wire LoopEngine into AppState: instantiate with real Clock/AudioBus, route Space key handling, forward pad presses to `LoopEngine::record_event`, call update per tick. Extend AudioCommand enum with metronome and scheduled playback variants produced by LoopEngine.\n  - Purpose: Connect engine to application runtime.\n  - _Leverage: design.md, existing AppState patterns_\n  - _Requirements: 1, 2, 3, 4, 5, 6_\n  - _Prompt: Role: Application integrator | Task: Integrate LoopEngine into existing AppState/input/audio modules, ensuring command dispatch aligns with design | Restrictions: Preserve existing pad behavior; ensure new commands don’t block audio thread | Success: Unit/integration tests compile; manual smoke (if run) shows state transitions via status text_\n\n- [ ] 9. Audio thread enhancements for scheduling & metronome\n  - File: src/audio.rs\n  - Handle new AudioCommand variants: synthesized metronome beep, scheduled pad playback using offsets and rodio sinks. Ensure non-blocking behavior and cleanup of finished sinks.\n  - Purpose: Provide audio-side support for loop engine.\n  - _Leverage: design.md, existing rodio setup_\n  - _Requirements: 2, 3, 4, 6_\n  - _Prompt: Role: Audio systems developer | Task: Extend audio thread to support metronome beep generation and scheduled playback triggered by LoopEngine commands | Restrictions: Avoid heap churn inside callback; maintain existing immediate play path | Success: Unit tests with mocked channel verify commands; manual smoke shows metronome tick and loop playback_\n\n- [ ] 10. Integration tests for AppState + LoopEngine\n  - File: tests/app_state_loop.rs\n  - Write integration tests covering full workflow: selection → enter pads → space ready/record/play with FakeClock and audio channel spy. Assert AppState status messages and command dispatch order.\n  - Purpose: Validate wiring across modules.\n  - _Leverage: requirements.md, design.md_\n  - _Requirements: 1, 2, 3, 4, 5, 6_\n  - _Prompt: Role: Rust integration tester | Task: Implement integration tests exercising AppState with LoopEngine and mocked audio sender | Restrictions: Use deterministic clock and stub metronome audio | Success: Tests confirm transitions, command dispatch order, and event capture_\n\n- [ ] 11. E2E script for loop capture via tui-test\n  - File: tests/e2e/loop_capture.test.ts\n  - Add @microsoft/tui-test scenario: assign sample to pad, enter pads, trigger recording, play pad, wait for auto playback. Verify console output/state via snapshots.\n  - Purpose: End-to-end validation of user story.\n  - _Leverage: requirements.md, design.md, existing tui-test config_\n  - _Requirements: 1, 2, 3, 4, 5, 6_\n  - _Prompt: Role: QA Automation Engineer (tui-test) | Task: Implement e2e test driving loop capture happy path with deterministic timing configuration | Restrictions: Use available fixtures; ensure test stable across runs | Success: Test passes after implementation; fails before audio enhancements are complete_\n\n- [ ] 12. Documentation & cleanup\n  - File: docs/tdd/loop_engine/behavior-matrix.md, README updates if needed\n  - Update documentation with final behavior matrix adjustments, usage instructions for loop recording, and known limitations. Ensure code comments reflect final architecture.\n  - Purpose: Wrap up spec deliverables.\n  - _Leverage: completed implementation and tests_\n  - _Requirements: 6_\n  - _Prompt: Role: Documentation steward | Task: Update docs and inline comments to reflect final loop recording behavior and testing strategy | Restrictions: Keep docs concise and aligned with spec | Success: Docs match shipped behavior; no outstanding TODOs in code_\n",
  "fileStats": {
    "size": 9660,
    "lines": 98,
    "lastModified": "2025-09-28T02:53:34.364Z"
  },
  "comments": []
}